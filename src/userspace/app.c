#include <stdint.h>

#include "sys.h"
#include "../lib/malloc.h"

static uint64_t a;
static uint64_t b;

static void fibNext() {
    uint64_t c = a;
    a = b;
    b = a + c;
}

void main() {
    a = 1;
    b = 1;

    while (b < 10000000000000000000ull)
        fibNext();

    printf("Hi, I'm app; I've stopped fib-ing with a: %u and b: %u\n", a, b);

    print("Say something, please? ");
    char* l = M_readline();
    if (l) {
        printf("  Thanks for saying \"%s\"\n", l);
        free(l);
    }

    // RIP: 0x159e2, 0x159f7, 0x15afa
    // That's in malloc.c, in malloc().
    /*

(qemu) info registers
RAX=0000000000000021 RBX=000000000000d48e RCX=00000000031f374b RDX=0000000000000b88
RSI=00000000031f3700 RDI=0000000000000018 RBP=000000000030fda0 RSP=000000000030fd50
R8 =0000000000013c55 R9 =0000000000016486 R10=0000000000014cce R11=0000000000000000
R12=0000000000000000 R13=0000000000000000 R14=0000000000000000 R15=0000000000000006
RIP=0000000000015afa RFL=00000006 [-----P-] CPL=0 II=0 A20=1 SMM=0 HLT=0
ES =0000 0000000000000000 000fffff 00000000
CS =0008 0000000000000000 00000fff 00a09b00 DPL=0 CS64 [-RA]
SS =0000 0000000000000000 000fffff 00400000
DS =0000 0000000000000000 000fffff 00000000
FS =0000 0000000000000000 000fffff 00000000
GS =0000 0000000000000000 000fffff 00000000
LDT=0000 0000000000000000 0000ffff 00008200 DPL=0 LDT
TR =0020 0000000000007e00 00000068 00008b00 DPL=0 TSS64-busy
GDT=     0000000000007d00 0000002f
IDT=     0000000000000000 00000fff
CR0=80000011 CR2=0000000000000000 CR3=0000000000001000 CR4=00000020
DR0=0000000000000000 DR1=0000000000000000 DR2=0000000000000000 DR3=0000000000000000 
DR6=00000000ffff0ff0 DR7=0000000000000400
EFER=0000000000000500
FCW=037f FSW=0000 [ST=0] FTW=00 MXCSR=00001f80
FPR0=0000000000000000 0000 FPR1=0000000000000000 0000
FPR2=0000000000000000 0000 FPR3=0000000000000000 0000
FPR4=0000000000000000 0000 FPR5=0000000000000000 0000
FPR6=0000000000000000 0000 FPR7=0000000000000000 0000
XMM00=0000000000000000 0000000000000000 XMM01=0000000000000000 0000000000000000
XMM02=0000000000000000 0000000000000000 XMM03=0000000000000000 0000000000000000
XMM04=0000000000000000 0000000000000000 XMM05=0000000000000000 0000000000000000
XMM06=0000000000000000 0000000000000000 XMM07=0000000000000000 0000000000000000
XMM08=0000000000000000 0000000000000000 XMM09=0000000000000000 0000000000000000
XMM10=0000000000000000 0000000000000000 XMM11=0000000000000000 0000000000000000
XMM12=0000000000000000 0000000000000000 XMM13=0000000000000000 0000000000000000
XMM14=0000000000000000 0000000000000000 XMM15=0000000000000000 0000000000000000
      */
    const uint64_t chunk = 1000000000ull; // Chunk that's not too fast, not too slow, for target system
    a = 0;

    for (; a < chunk; a++)
        if (a % (chunk / 10) == 0)
            printf("a: %u\n", a);
    print("Ending without a newline.");
}
